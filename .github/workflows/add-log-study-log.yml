name: sdd study log
on:
  push:
    branches:
      - main
      - develop
  schedule:
    - cron: "10 15 * * *"
  workflow_dispatch:
jobs:
  add-study-log:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: add for new commits in the last 24 hours
        id: check_commits
        run: |
          NOW=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          YESTERDAY=$(date -u -d "24 hours ago" +"%Y-%m-%dT%H:%M:%SZ")
          COMMITS=$(git log --since="$YESTERDAY" --until="$NOW" --pretty=format:"%H" | tr '\n' ',')
          echo "コミットは${COMMITS}"
          echo "commit_hashes=${COMMITS}" >> $GITHUB_ENV
          if [ -z "$COMMITS" ]; then
            echo "No commits found in the last 24 hours."
          else
            echo "Commits found:"
            TIMESTAMP=$(date "+%Y-%m-%d")
            echo "## study-log 作業記録 ${TIMESTAMP}" >> study-log.md
            for commit in ${COMMITS[@]}; do
              echo "https://github.com/${{ github.repository }}/commit/${commit} <br>" >> study-log.md
            done
            git config user.name "onishi-teppei"
            git config user.email "teppei99.nxw@gmail.com"
            git add ./study-log.md
            git commit -m "Update study log with commits from the last 24 hours"
            git push origin main
          fi

      - name: Print commit hashes
        run: |
          # 環境変数を配列として分割
          IFS=',' read -r -a commits_array <<< "${{ env.commit_hashes }}"
          for commit in "${commits_array[@]}"; do
            echo "Commit: $commit"
          done
